name: Build TWRP for TALIH-PD1

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build TWRP (AOSP)
    runs-on: ubuntu-20.04
    env:
      DEVICE: TALIH-PD1
      TARGET: recovery
      THREADS: 4

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential curl flex g++-multilib gcc-multilib git gnupg gperf \
          libncurses5-dev:i386 libstdc++6:i386 zlib1g:i386 libssl-dev python3 unzip xz-utils zip

    - name: Setup environment
      run: |
        mkdir -p ~/twrp
        export PATH=$HOME/bin:$PATH
        export ANDROID_BUILD_TOP=$PWD

    - name: Initialize repo (if using AOSP manifests)
      run: |
        # 如果你有 TWRP/AOSP manifest，可以在这里初始化
        # repo init -u https://github.com/LineageOS/android.git -b twrp-11.0
        # repo sync -c --no-tags --no-clone-bundle -j$THREADS
        echo "Skip repo init, using local device tree"

    - name: Build recovery
      run: |
        source build/envsetup.sh
        lunch omni_$DEVICE-$TARGET
        make -j$THREADS recoveryimage

    - name: Upload recovery image
      uses: actions/upload-artifact@v4
      with:
        name: recovery-image
        path: out/target/product/$DEVICE/recovery.img
