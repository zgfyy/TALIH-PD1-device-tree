name: Build TWRP (AOSP) for TALIH-PD1

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    env:
      DEVICE: TALIH-PD1
      TARGET: twrp

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2️⃣ Set up dependencies
      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf \
            lib32z1-dev lib32ncurses6-dev liblz4-tool \
            libncurses5 libncurses5-dev libsdl1.2-dev \
            libssl-dev libxml2 libxml2-utils lzop \
            openjdk-11-jdk pngcrush rsync schedtool \
            squashfs-tools xsltproc zip zlib1g-dev repo

      # 3️⃣ Initialize environment (optional, if needed)
      - name: Source environment
        run: |
          echo "Set up build environment"
          source build/envsetup.sh || true

      # 4️⃣ Lunch device
      - name: Lunch device
        run: |
          lunch ${DEVICE}-${TARGET}-eng || true

      # 5️⃣ Start build
      - name: Build TWRP
        run: |
          make -j$(nproc) recoveryimage

      # 6️⃣ Upload artifact
      - name: Upload TWRP image
        uses: actions/upload-artifact@v4
        with:
          name: TWRP-${DEVICE}
          path: out/target/product/${DEVICE}/recovery.img
